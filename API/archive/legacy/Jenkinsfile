pipeline {
    agent any
    
    // Global environment variables
    environment {
        DOCKER_IMAGE_NAME = 'whatshouldido-api'
        DOCKER_REGISTRY = 'your-registry.com' // Update with your registry
        DOTNET_CLI_TELEMETRY_OPTOUT = '1'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE = '1'
    }
    
    // Pipeline triggers
    triggers {
        githubPush()
    }
    
    // Build parameters
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['auto', 'development', 'production'],
            description: 'Target environment (auto = based on branch)'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Skip running tests'
        )
        booleanParam(
            name: 'FORCE_DEPLOY',
            defaultValue: false,
            description: 'Force deployment even if tests fail'
        )
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    // Determine target environment based on branch
                    if (params.ENVIRONMENT == 'auto') {
                        if (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master') {
                            env.TARGET_ENV = 'production'
                            env.DEPLOY_HOST = 'your-production-server.com'
                            env.DEPLOY_PORT = '5000'
                            env.ENV_FILE = '.env.production'
                        } else if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'dev') {
                            env.TARGET_ENV = 'development'
                            env.DEPLOY_HOST = 'your-dev-server.com'
                            env.DEPLOY_PORT = '5001'
                            env.ENV_FILE = '.env.development'
                        } else {
                            env.TARGET_ENV = 'development'  // Default to dev for feature branches
                            env.DEPLOY_HOST = 'your-dev-server.com'
                            env.DEPLOY_PORT = '5001'
                            env.ENV_FILE = '.env.development'
                        }
                    } else {
                        env.TARGET_ENV = params.ENVIRONMENT
                        if (env.TARGET_ENV == 'production') {
                            env.DEPLOY_HOST = 'your-production-server.com'
                            env.DEPLOY_PORT = '5000'
                            env.ENV_FILE = '.env.production'
                        } else {
                            env.DEPLOY_HOST = 'your-dev-server.com'
                            env.DEPLOY_PORT = '5001'
                            env.ENV_FILE = '.env.development'
                        }
                    }
                    
                    // Set build version
                    env.BUILD_VERSION = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(8)}"
                    env.DOCKER_TAG = "${env.TARGET_ENV}-${env.BUILD_VERSION}"
                    
                    echo "üöÄ Starting build for WhatShouldIDo API"
                    echo "üìã Build Information:"
                    echo "   Branch: ${env.BRANCH_NAME}"
                    echo "   Environment: ${env.TARGET_ENV}"
                    echo "   Version: ${env.BUILD_VERSION}"
                    echo "   Deploy Host: ${env.DEPLOY_HOST}"
                    echo "   Docker Tag: ${env.DOCKER_TAG}"
                }
            }
        }
        
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
                
                // Clean workspace
                sh '''
                    echo "üßπ Cleaning workspace..."
                    rm -rf bin/ obj/ TestResults/
                    find . -name "*.log" -delete
                '''
            }
        }
        
        stage('Restore Dependencies') {
            steps {
                echo 'üì¶ Restoring NuGet packages...'
                sh '''
                    cd src/WhatShouldIDo.API
                    dotnet restore WhatShouldIDo.API.csproj --verbosity minimal
                '''
            }
        }
        
        stage('Build') {
            steps {
                echo 'üî® Building application...'
                sh '''
                    cd src/WhatShouldIDo.API
                    dotnet build WhatShouldIDo.API.csproj \
                        --configuration Release \
                        --no-restore \
                        --verbosity minimal \
                        -p:Version=${BUILD_VERSION}
                '''
            }
            post {
                always {
                    // Archive build artifacts
                    archiveArtifacts artifacts: 'src/WhatShouldIDo.API/bin/Release/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Run Tests') {
            when {
                not { params.SKIP_TESTS }
            }
            parallel {
                stage('Unit Tests') {
                    steps {
                        echo 'üß™ Running unit tests...'
                        sh '''
                            cd src/WhatShouldIDo.Tests
                            dotnet test WhatShouldIDo.API.IntegrationTests.csproj \
                                --configuration Release \
                                --no-build \
                                --verbosity normal \
                                --logger "trx;LogFileName=unit-test-results.trx" \
                                --collect:"XPlat Code Coverage"
                        '''
                    }
                }
                
                stage('Integration Tests') {
                    steps {
                        echo 'üîó Running integration tests...'
                        sh '''
                            # Start test dependencies (if needed)
                            # docker-compose -f docker-compose.test.yml up -d
                            
                            cd src/WhatShouldIDo.Tests
                            dotnet test WhatShouldIDo.API.IntegrationTests.csproj \
                                --configuration Release \
                                --no-build \
                                --verbosity normal \
                                --logger "trx;LogFileName=integration-test-results.trx"
                                
                            # Clean up test dependencies
                            # docker-compose -f docker-compose.test.yml down
                        '''
                    }
                }
            }
            post {
                always {
                    // Publish test results
                    publishTestResults testResultsPattern: 'TestResults/**/*.trx'
                    
                    // Publish code coverage
                    publishCoverageResults(
                        adapters: [
                            coberturaAdapter('TestResults/**/coverage.cobertura.xml')
                        ],
                        sourceFileResolver: sourceFiles('STORE_LAST_BUILD')
                    )
                }
                failure {
                    script {
                        if (!params.FORCE_DEPLOY) {
                            error "Tests failed. Use FORCE_DEPLOY parameter to deploy anyway."
                        } else {
                            echo "‚ö†Ô∏è Tests failed but FORCE_DEPLOY is enabled. Continuing..."
                        }
                    }
                }
            }
        }
        
        stage('Security Scan') {
            parallel {
                stage('Dependency Scan') {
                    steps {
                        echo 'üîç Scanning dependencies for vulnerabilities...'
                        sh '''
                            cd src/WhatShouldIDo.API
                            dotnet list package --vulnerable --include-transitive > dependency-scan.txt
                            cat dependency-scan.txt
                        '''
                    }
                }
                
                stage('Secret Scan') {
                    steps {
                        echo 'üîê Scanning for secrets...'
                        sh '''
                            # Check for potential secrets in code
                            echo "Checking for API keys and secrets..."
                            if grep -r "API_KEY\\|SECRET\\|PASSWORD\\|TOKEN" src/ --include="*.cs" --include="*.json"; then
                                echo "‚ö†Ô∏è Potential secrets found in source code"
                            else
                                echo "‚úÖ No obvious secrets found in source code"
                            fi
                        '''
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'dependency-scan.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                script {
                    def dockerImage = docker.build("${DOCKER_IMAGE_NAME}:${DOCKER_TAG}", "-f src/WhatShouldIDo.API/Dockerfile .")
                    
                    // Tag for registry
                    dockerImage.tag("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${DOCKER_TAG}")
                    dockerImage.tag("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${env.TARGET_ENV}-latest")
                    
                    env.DOCKER_IMAGE_ID = dockerImage.id
                }
            }
        }
        
        stage('Push to Registry') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                    branch 'dev'
                }
            }
            steps {
                echo 'üì§ Pushing Docker image to registry...'
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        def image = docker.image("${DOCKER_IMAGE_NAME}:${DOCKER_TAG}")
                        image.push()
                        image.push("${env.TARGET_ENV}-latest")
                    }
                }
            }
        }
        
        stage('Deploy to Environment') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                    branch 'dev'
                }
            }
            steps {
                echo "üöÄ Deploying to ${env.TARGET_ENV} environment..."
                script {
                    // Use different deployment strategies based on environment
                    if (env.TARGET_ENV == 'production') {
                        // Production deployment with blue-green strategy
                        sh '''
                            echo "üîµ Starting production deployment..."
                            
                            # Copy environment file
                            scp -o StrictHostKeyChecking=no ${ENV_FILE} deploy@${DEPLOY_HOST}:~/whatshouldido/.env
                            
                            # Deploy with zero-downtime strategy
                            ssh -o StrictHostKeyChecking=no deploy@${DEPLOY_HOST} '
                                cd ~/whatshouldido
                                
                                # Pull latest images
                                docker-compose -f docker-compose.prod.yml pull
                                
                                # Start new containers alongside old ones
                                docker-compose -f docker-compose.prod.yml up -d --scale api=2
                                
                                # Wait for health check
                                sleep 30
                                
                                # Health check
                                if curl -f http://localhost:${DEPLOY_PORT}/api/health; then
                                    echo "‚úÖ Health check passed"
                                    # Stop old containers
                                    docker-compose -f docker-compose.prod.yml up -d --scale api=1
                                else
                                    echo "‚ùå Health check failed"
                                    # Rollback
                                    docker-compose -f docker-compose.prod.yml down
                                    docker-compose -f docker-compose.prod.yml up -d
                                    exit 1
                                fi
                            '
                        '''
                    } else {
                        // Development deployment with simple restart
                        sh '''
                            echo "üü° Starting development deployment..."
                            
                            # Copy environment file
                            scp -o StrictHostKeyChecking=no ${ENV_FILE} deploy@${DEPLOY_HOST}:~/whatshouldido-dev/.env
                            
                            # Simple deployment
                            ssh -o StrictHostKeyChecking=no deploy@${DEPLOY_HOST} '
                                cd ~/whatshouldido-dev
                                
                                # Stop existing containers
                                docker-compose -f docker-compose.dev.yml down
                                
                                # Pull and start new containers
                                docker-compose -f docker-compose.dev.yml pull
                                docker-compose -f docker-compose.dev.yml up -d
                                
                                # Wait and check health
                                sleep 15
                                if curl -f http://localhost:${DEPLOY_PORT}/api/health; then
                                    echo "‚úÖ Development deployment successful"
                                else
                                    echo "‚ùå Development deployment failed"
                                    exit 1
                                fi
                            '
                        '''
                    }
                }
            }
            post {
                success {
                    echo "‚úÖ Deployment to ${env.TARGET_ENV} completed successfully!"
                }
                failure {
                    echo "‚ùå Deployment to ${env.TARGET_ENV} failed!"
                }
            }
        }
        
        stage('Post-Deploy Tests') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                    branch 'dev'
                }
            }
            steps {
                echo 'üß™ Running post-deployment tests...'
                script {
                    def apiUrl = "https://${env.DEPLOY_HOST}"
                    if (env.TARGET_ENV == 'development') {
                        apiUrl = "https://dev.${env.DEPLOY_HOST}"
                    }
                    
                    sh """
                        echo "Testing API endpoints at ${apiUrl}..."
                        
                        # Health check
                        curl -f ${apiUrl}/api/health
                        
                        # Basic functionality test
                        curl -f -X POST ${apiUrl}/api/discover/prompt \\
                            -H "Content-Type: application/json" \\
                            -d '{"prompt":"restaurants","latitude":41.0082,"longitude":28.9784}'
                        
                        echo "‚úÖ Post-deployment tests passed"
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Cleaning up workspace...'
            
            // Clean up Docker images to save space
            sh '''
                echo "Cleaning up old Docker images..."
                docker image prune -f
                docker container prune -f
            '''
            
            // Archive logs
            archiveArtifacts artifacts: 'logs/**/*.log', allowEmptyArchive: true
        }
        
        success {
            echo "‚úÖ Pipeline completed successfully!"
            
            // Send success notification
            script {
                def message = """
üéâ **Build Success**
**Project**: WhatShouldIDo API
**Branch**: ${env.BRANCH_NAME}
**Environment**: ${env.TARGET_ENV}
**Version**: ${env.BUILD_VERSION}
**Build**: #${env.BUILD_NUMBER}
**Commit**: ${env.GIT_COMMIT.take(8)}
"""
                
                // Slack notification (if configured)
                slackSend(
                    color: 'good',
                    message: message,
                    channel: '#deployments'
                )
                
                // Email notification (if configured)
                emailext(
                    subject: "‚úÖ WhatShouldIDo API Build #${env.BUILD_NUMBER} - Success",
                    body: message,
                    recipientProviders: [developers(), requestor()]
                )
            }
        }
        
        failure {
            echo "‚ùå Pipeline failed!"
            
            // Send failure notification
            script {
                def message = """
üí• **Build Failed**
**Project**: WhatShouldIDo API
**Branch**: ${env.BRANCH_NAME}
**Environment**: ${env.TARGET_ENV}
**Build**: #${env.BUILD_NUMBER}
**Commit**: ${env.GIT_COMMIT.take(8)}
**Stage**: ${env.STAGE_NAME}
**Log**: ${env.BUILD_URL}console
"""
                
                // Slack notification (if configured)
                slackSend(
                    color: 'danger',
                    message: message,
                    channel: '#deployments'
                )
                
                // Email notification (if configured)
                emailext(
                    subject: "‚ùå WhatShouldIDo API Build #${env.BUILD_NUMBER} - Failed",
                    body: message,
                    recipientProviders: [developers(), requestor(), culprits()]
                )
            }
        }
        
        unstable {
            echo "‚ö†Ô∏è Pipeline completed with warnings"
        }
        
        changed {
            echo "üìä Build status changed from previous build"
        }
    }
}